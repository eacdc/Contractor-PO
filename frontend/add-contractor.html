<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Contractor PO System - Add New Contractor</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="app">
      <header class="app-header">
        <div class="brand">
          <div class="brand-logo">CP</div>
          <div class="brand-text">
            <h1>Contractor PO System</h1>
            <p>Create and manage contractors.</p>
          </div>
        </div>
        <a href="home.html" class="home-btn">Home</a>
      </header>

      <main class="app-main app-main--home">
        <section class="intro">
          <h2>Add New Contractor</h2>
          <p>Enter contractor name and click ADD to save.</p>
        </section>

        <!-- Add Contractor Form -->
        <section class="panel">
          <header class="panel-header">
            <h3>Add Contractor</h3>
          </header>
          <div class="panel-body">
            <div class="add-ops-inline">
              <div class="field">
                <label for="contractorName">Contractor Name</label>
                <input
                  id="contractorName"
                  name="contractorName"
                  type="text"
                  placeholder="Enter contractor name"
                  required
                />
              </div>
              <div class="add-ops-actions">
                <button class="primary-btn primary-btn--sm" type="button" id="addContractorBtn">
                  ADD
                </button>
              </div>
            </div>

            <p class="inline-warning" id="addContractorWarning"></p>
          </div>
        </section>

        <!-- Contractors Table -->
        <section class="panel">
          <header class="panel-header">
            <h3>All Contractors</h3>
          </header>
          <div class="panel-body">
            <div class="table-wrapper" id="contractorsTableWrapper">
              <table class="data-table" id="contractorsTable">
                <thead>
                  <tr>
                    <th>Contractor Name</th>
                    <th>Creation Date</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody id="contractorsTableBody">
                  <tr>
                    <td colspan="3" style="text-align: center; color: var(--text-muted);">
                      Loading contractors...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>
      </main>

      <footer class="app-footer">
        <span>Contractor PO System</span>
        <span class="divider">â€¢</span>
        <span>Add New Contractor</span>
      </footer>
    </div>

    <script type="module">
      import { contractorsAPI } from './api.js';

      const contractorNameInput = document.getElementById('contractorName');
      const addContractorBtn = document.getElementById('addContractorBtn');
      const addContractorWarning = document.getElementById('addContractorWarning');
      const contractorsTableBody = document.getElementById('contractorsTableBody');
      const contractorsTableWrapper = document.getElementById('contractorsTableWrapper');

      // Format date for display
      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }

      // Load and display contractors
      async function loadContractors() {
        try {
          const contractors = await contractorsAPI.getAll();
          
          if (contractors.length === 0) {
            contractorsTableBody.innerHTML = `
              <tr>
                <td colspan="3" style="text-align: center; color: var(--text-muted);">
                  No contractors found. Add your first contractor above.
                </td>
              </tr>
            `;
            return;
          }

          contractorsTableBody.innerHTML = contractors.map(contractor => `
            <tr data-id="${contractor._id}">
              <td>
                <span class="contractor-name-display">${contractor.name}</span>
                <input type="text" class="contractor-name-edit" value="${contractor.name}" style="display: none; width: 100%;">
              </td>
              <td>${formatDate(contractor.creationDate)}</td>
              <td>
                <button class="edit-btn" data-id="${contractor._id}" style="margin-right: 8px;">Edit</button>
                <button class="delete-btn" data-id="${contractor._id}" style="background-color: #ef4444; color: white; border: none; padding: 4px 12px; border-radius: 4px; cursor: pointer;">Delete</button>
              </td>
            </tr>
          `).join('');
          
          // Attach event listeners for edit and delete buttons
          attachContractorEventListeners();
        } catch (error) {
          console.error('Error loading contractors:', error);
          contractorsTableBody.innerHTML = `
            <tr>
              <td colspan="3" style="text-align: center; color: #ef4444;">
                Error loading contractors. Please refresh the page.
              </td>
            </tr>
          `;
        }
      }

      // Attach event listeners for edit and delete buttons
      function attachContractorEventListeners() {
        // Edit buttons
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const contractorId = this.getAttribute('data-id');
            const row = this.closest('tr');
            const nameDisplay = row.querySelector('.contractor-name-display');
            const nameEdit = row.querySelector('.contractor-name-edit');
            const editBtn = row.querySelector('.edit-btn');
            
            if (nameEdit.style.display === 'none') {
              // Switch to edit mode
              nameDisplay.style.display = 'none';
              nameEdit.style.display = 'inline-block';
              editBtn.textContent = 'Save';
              
              nameEdit.focus();
              nameEdit.select();
              
              // Handle save on Enter key
              const saveHandler = async (e) => {
                if (e.key === 'Enter') {
                  nameEdit.removeEventListener('keypress', saveHandler);
                  await saveContractorEdit(contractorId, nameEdit.value.trim(), row);
                }
              };
              
              // Handle cancel on Escape key
              const cancelHandler = (e) => {
                if (e.key === 'Escape') {
                  nameEdit.removeEventListener('keypress', saveHandler);
                  nameEdit.removeEventListener('keydown', cancelHandler);
                  nameDisplay.style.display = 'inline';
                  nameEdit.style.display = 'none';
                  editBtn.textContent = 'Edit';
                  nameEdit.value = nameDisplay.textContent;
                }
              };
              
              nameEdit.addEventListener('keypress', saveHandler);
              nameEdit.addEventListener('keydown', cancelHandler);
            } else {
              // Save mode
              await saveContractorEdit(contractorId, nameEdit.value.trim(), row);
            }
          });
        });
        
        // Delete buttons
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async function() {
            const contractorId = this.getAttribute('data-id');
            const contractorName = this.closest('tr').querySelector('.contractor-name-display').textContent;
            
            if (confirm(`Are you sure you want to delete "${contractorName}"?`)) {
              try {
                await contractorsAPI.delete(contractorId);
                await loadContractors();
                addContractorWarning.textContent = 'Contractor deleted successfully!';
                addContractorWarning.style.color = '#4ade80';
                setTimeout(() => {
                  addContractorWarning.textContent = '';
                }, 3000);
              } catch (error) {
                addContractorWarning.style.color = '#ef4444';
                addContractorWarning.textContent = error.message || 'Failed to delete contractor.';
              }
            }
          });
        });
      }

      // Save contractor edit
      async function saveContractorEdit(contractorId, newName, row) {
        if (!newName) {
          addContractorWarning.style.color = '#ef4444';
          addContractorWarning.textContent = 'Contractor name cannot be empty.';
          return;
        }
        
        try {
          await contractorsAPI.update(contractorId, newName);
          const nameDisplay = row.querySelector('.contractor-name-display');
          const nameEdit = row.querySelector('.contractor-name-edit');
          const editBtn = row.querySelector('.edit-btn');
          
          nameDisplay.textContent = newName;
          nameDisplay.style.display = 'inline';
          nameEdit.style.display = 'none';
          editBtn.textContent = 'Edit';
          
          addContractorWarning.textContent = 'Contractor updated successfully!';
          addContractorWarning.style.color = '#4ade80';
          setTimeout(() => {
            addContractorWarning.textContent = '';
          }, 3000);
        } catch (error) {
          addContractorWarning.style.color = '#ef4444';
          addContractorWarning.textContent = error.message || 'Failed to update contractor.';
        }
      }

      // Add new contractor
      if (contractorNameInput && addContractorBtn && addContractorWarning) {
        addContractorBtn.addEventListener('click', async () => {
          const name = contractorNameInput.value.trim();

          // Validate
          if (!name) {
            addContractorWarning.textContent = 'Please enter a contractor name.';
            addContractorWarning.style.color = '#ef4444';
            return;
          }

          try {
            await contractorsAPI.create(name);
            
            // Show success message
            addContractorWarning.textContent = 'Contractor added successfully!';
            addContractorWarning.style.color = '#4ade80';

            // Clear input
            contractorNameInput.value = '';

            // Reload contractors table
            await loadContractors();

            // Clear success message after 3 seconds
            setTimeout(() => {
              addContractorWarning.textContent = '';
            }, 3000);
          } catch (error) {
            addContractorWarning.style.color = '#ef4444';
            addContractorWarning.textContent = error.message || 'Failed to add contractor.';
          }
        });

        // Allow Enter key to submit
        contractorNameInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            addContractorBtn.click();
          }
        });
      }

      // Load contractors on page load
      loadContractors();
    </script>
  </body>
</html>
